---
/**
 * VARIANTE ALTERNATIVA - Blog Index con Layout Lista Compatto
 * 
 * Questa versione mostra i post in una lista verticale pi첫 compatta,
 * simile all'originale ma con design NomaPhone.
 * 
 * Usa questa se preferisci:
 * - Vedere pi첫 post in una schermata
 * - Layout pi첫 tradizionale da blog
 * - Hero image pi첫 piccola a sinistra
 */

import { getCollection } from "astro:content";
import { Image } from "astro:assets";

import BaseHead from "@/components/BaseHead.astro";
import NomaPhoneHeader from "@/components/NomaPhoneHeader";
import Footer from "@/components/Footer";
import FormattedDate from "@/components/FormattedDate.astro";
import { Badge } from "@/components/ui/badge";
import { Calendar, Clock, ArrowRight } from "lucide-react";
import "@/styles/global.css";
import { isPublished } from "@/lib/filterPublishedPosts";

const entries = await getCollection("blog", ({ data }) => {
  return isPublished(data.pubDate);
});

const toSlug = (e: any) => {
  if (e.slug) return e.slug;
  if (typeof e.id === "string") {
    const base = e.id.split("/").pop();
    return (base ?? "").replace(/\.(md|mdx|markdown)$/, "");
  }
  return "";
};

const posts = entries
  .map((e) => ({
    slug: toSlug(e),
    title: e.data.title,
    description: e.data.description ?? "",
    pubDate: e.data.pubDate,
    updatedDate: e.data.updatedDate ?? null,
    tags: Array.isArray(e.data.tags) ? e.data.tags : [],
    hero: e.data.heroImage ?? null,
  }))
  .sort((a, b) => {
    const da = a.pubDate?.getTime?.() ?? 0;
    const db = b.pubDate?.getTime?.() ?? 0;
    return db - da;
  });

const pageTitle = "Blog";
const pageDescription = "Insights, guides, and updates on international calling for digital nomads";
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={pageTitle} description={pageDescription} />
    <script is:inline>
      const theme = (() => {
        if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
          return localStorage.getItem('theme');
        }
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          return 'dark';
        }
        return 'light';
      })();
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      }
    </script>
  </head>
  
  <body>
    <NomaPhoneHeader client:load currentPath="/blog" />
    
    <main class="min-h-screen bg-background">
      <!-- Hero -->
      <section class="border-b">
        <div class="container mx-auto px-4 py-12 md:py-16">
          <div class="mx-auto max-w-4xl">
            <h1 class="mb-3 text-4xl font-bold tracking-tight md:text-5xl">
              <span class="bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent">
                {pageTitle}
              </span>
            </h1>
            <p class="text-lg text-muted-foreground">
              {pageDescription}
            </p>
          </div>
        </div>
      </section>

      <!-- Posts List -->
      <section class="container mx-auto px-4 py-12">
        <div class="mx-auto max-w-4xl">
          {posts.length === 0 ? (
            <div class="text-center py-20">
              <p class="text-muted-foreground">No posts yet. Check back soon!</p>
            </div>
          ) : (
            <ul class="space-y-8">
              {posts.map((post) => (
                <li class="group">
                  <a 
                    href={`/blog/${post.slug}/`}
                    class="block overflow-hidden rounded-xl border-2 bg-card transition-all hover:border-blue-200 hover:shadow-lg dark:hover:border-blue-800"
                  >
                    <div class="flex flex-col gap-4 p-6 sm:flex-row sm:gap-6">
                      {/* Hero Image - Side on desktop */}
                      {post.hero && (
                        <div class="relative w-full shrink-0 overflow-hidden rounded-lg sm:w-48">
                          <div class="aspect-video sm:aspect-square">
                            {typeof post.hero === "object" ? (
                              <Image 
                                src={post.hero} 
                                width={400} 
                                height={400} 
                                alt={post.title}
                                class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
                              />
                            ) : (
                              <img 
                                src={post.hero} 
                                alt={post.title}
                                class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
                                loading="lazy"
                              />
                            )}
                          </div>
                        </div>
                      )}

                      {/* Content */}
                      <div class="flex flex-1 flex-col justify-between">
                        <div>
                          {/* Date */}
                          <div class="mb-2 flex flex-wrap items-center gap-3 text-sm text-muted-foreground">
                            <div class="flex items-center gap-1.5">
                              <Calendar className="h-3.5 w-3.5" />
                              <FormattedDate date={post.pubDate} />
                            </div>
                            {post.updatedDate && (
                              <div class="flex items-center gap-1.5">
                                <Clock className="h-3.5 w-3.5" />
                                <FormattedDate date={post.updatedDate} />
                              </div>
                            )}
                          </div>

                          {/* Title */}
                          <h2 class="mb-2 text-xl font-bold tracking-tight group-hover:text-blue-600 transition-colors sm:text-2xl">
                            {post.title}
                          </h2>

                          {/* Description */}
                          {post.description && (
                            <p class="mb-3 text-sm text-muted-foreground line-clamp-2 sm:text-base">
                              {post.description}
                            </p>
                          )}

                          {/* Tags */}
                          {post.tags && post.tags.length > 0 && (
                            <div class="mb-3 flex flex-wrap gap-2">
                              {post.tags.slice(0, 4).map((tag) => (
                                <Badge variant="secondary" className="text-xs">
                                  {tag}
                                </Badge>
                              ))}
                            </div>
                          )}
                        </div>

                        {/* Read more */}
                        <div class="flex items-center gap-2 text-sm font-medium text-blue-600 group-hover:gap-3 transition-all">
                          <span>Read article</span>
                          <ArrowRight className="h-4 w-4 transition-transform group-hover:translate-x-1" />
                        </div>
                      </div>
                    </div>
                  </a>
                </li>
              ))}
            </ul>
          )}
        </div>
      </section>
    </main>

    <Footer client:load />
  </body>
</html>